# Gomoku

This demo app allows users to start and join Gomoku games via the App smart contract. The game interacts with the ABCI core for gameplay, and the final results are settled back to the App smart contract.

## Components

The demo consists of three main sections:

### 1. App Smart Contract
For full details, refer to [./contract/README.md](./contract/README.md).

### 2. App ABCI Core
For full details, refer to [./server/README.md](./server/README.md).

### 3. App ABCI Client
For full details, refer to [./client/README.md](./client/README.md).

## Setup Guide
Follow these steps to set up and run the app locally.

### 1. Start the Chain
Navigate to the `contract` folder:
```bash
cd contract
```

Copy the example environment file:
```bash
cp .env.example .env
```

Start the local node:
```bash
make node
```
This command initializes the local chain and deploys the smart contract. A few addresses will be generated by Foundry; we will use the following two for testing:

#### Test Addresses
```
Address 1: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
Private Key: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

Address 2: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
Private Key: 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d
```

### 2. Start Fleet Manager (Docker)
Pull the Sparsity dispatcher Docker image:
```bash
docker pull sparsityxyz/fleet-er
```

Run the Docker container locally and manually whitelist the test addresses in the auth module:
```bash
docker run -ti --rm -p 9981:9981 sparsityxyz/fleet-er --no-indexer --mock-address 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --mock-address 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
```

Wait for the signal:
```
Dialed server. Waiting for echo.
module=abci-client connection=query addr=host.docker.internal:26658
```

### 3. Start the ABCI Core Server
Navigate to the `server` folder:
```bash
cd server
```

Install dependencies:
```bash
npm install
```

Run the app:
```bash
npm run start
```

Wait for the signal:
```
Server running on 26658
```

### 4. Start the App Client
Navigate to the `client` folder:
```bash
cd client
```

Install dependencies:
```bash
npm install
```

Create a project in [Reown](https://reown.com/blog/how-to-get-started-with-appkit) and fill in the `VITE_PROJECT_ID` in the `.env` file:
```
VITE_PROJECT_ID=
```

Run the app:
```bash
yarn start
# or
npm run start
```

You can now play the game locally at [http://localhost:5173](http://localhost:5173)!

## Operations

### 5. Connect Wallet
Open [http://localhost:5173](http://localhost:5173) in your browser and connect wallet `0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266`.

### 6. Join Game
Click the **Join Game** button and sign the transaction. Ensure it is connected to the **Localhost** chain.

### 7. Open Another Session & Join with a Different Address
Use a different browser session and connect with address `0x70997970C51812dc3A010C7d01b50e0d17dc79C8` to join the game.

### 8. Manually Bridge Outpost & Settle App Smart Contract Session
Open a new terminal and navigate to the `contract` folder:
```bash
cd contract
```

Run the script:
```bash
make callback-session SID=1
```
**Note:** `SID` corresponds to the session ID in the App smart contract.

### 9. Simulate Gomoku Gameplay Between Two Local Users

### 10. Detect Game Winner
Once the game finishes, you should see a message like this in the ABCI core terminal:
```
status:  true 0x000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb9226600000000000000000000000070997970c51812dc3a010c7d01b50e0d17dc79c8000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb92266
```

### 11. Manually Bridge Sparsity Network to App Contract for Result Settlement
Open a new terminal and navigate to the `contract` folder:
```bash
cd contract
```

Run the script:
```bash
make callback-settle SID=1 RESULT=0x000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb9226600000000000000000000000070997970c51812dc3a010c7d01b50e0d17dc79c8000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb92266
```
**Note:** `SID` corresponds to the session ID in the App smart contract.

Now the result is settled back on-chain in the App smart contract.

